#!/usr/bin/env bash
# Initialize the richdocuments ODFWEB app
#
# Copyright 2025 Buo-ren Lin (OSSII) <buoren@ossii.com.tw>
# SPDX-License-Identifier: AGPL-3.0-or-later

if ! set -eu; then
    printf 'Error: Unable to configure defensive interpreter behaviors.\n' >&2
    exit 2
fi

# Enable the richdocuments app by default
if ! php occ app:enable richdocuments; then
    printf 'Error: Unable to enable the richdocuments app.\n' >&2
    exit 2
fi

# NOTE: This will work as client fetches editor URL via the server_name editor config, not from here
if ! php occ richdocuments:activate-config --wopi-url='http://editor:9980/'; then
    printf 'Error: Unable to configure the WOPI URL of the MODAODFWEB service.\n' >&2
    exit 2
fi

# Workaround admin console URL break due to the client-inaccessible http://editor:9980/ WOPI URL
if ! php occ config:app:set richdocuments wopi_url --value "https://__ODFWEB_DOMAIN_NAME__"; then
    printf 'Error: Unable to configure the WOPI URL of the MODAODFWEB service.\n' >&2
    exit 2
fi

if ! php occ config:app:set richdocuments disable_certificate_verification --value yes; then
    printf 'Error: Unable to configure the WOPI URL of the MODAODFWEB service.\n' >&2
    exit 2
fi
